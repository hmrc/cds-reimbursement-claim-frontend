@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.twirl.api.Html
@import play.api.i18n.Messages
@import play.api.mvc.Request
@import uk.gov.hmrc.cdsreimbursementclaimfrontend.config.ViewConfig
@import uk.gov.hmrc.cdsreimbursementclaimfrontend.controllers.securities.routes
@import uk.gov.hmrc.cdsreimbursementclaimfrontend.views.helpers._
@import uk.gov.hmrc.govukfrontend.views.viewmodels.summarylist.SummaryList
@import uk.gov.hmrc.cdsreimbursementclaimfrontend.claims.SecuritiesClaim
@import uk.gov.hmrc.cdsreimbursementclaimfrontend.models.declaration.ImportDeclaration
@import uk.gov.hmrc.cdsreimbursementclaimfrontend.models.ReasonForSecurity
@import uk.gov.hmrc.cdsreimbursementclaimfrontend.models.UploadDocumentType
@import uk.gov.hmrc.cdsreimbursementclaimfrontend.models.ids.MRN
@import uk.gov.hmrc.cdsreimbursementclaimfrontend.models.ReasonForSecurity.InwardProcessingRelief

@this(
        subHeading: uk.gov.hmrc.cdsreimbursementclaimfrontend.views.html.components.sub_heading,
        summary: uk.gov.hmrc.cdsreimbursementclaimfrontend.views.html.components.summary,
        card: uk.gov.hmrc.cdsreimbursementclaimfrontend.views.html.components.card
)

@(claim: SecuritiesClaim.Output, isSingleSecurity: Boolean, importDeclarationOpt: Option[ImportDeclaration], exportDeclarationMrnOpt: Option[Seq[MRN]], isPrintView: Boolean = false)(implicit request: Request[?], messages: Messages, viewConfig: ViewConfig)

@singleSecurity = {
    @card(messages(s"check-your-answers.claim-details"), CheckYourAnswersClaimDetailsCardSummary.renderForSecurities(claim, importDeclarationOpt, isPrintView))
    
    @if(claim.reasonForSecurity == ReasonForSecurity.InwardProcessingRelief || 
        claim.reasonForSecurity == ReasonForSecurity.EndUseRelief
    ){
        @card(messages(s"check-your-answers.attached-documents.h2"), CheckYourAnswersSupportingDocumentsCardSummary.withSeparatelyUploadedDocuments(claim.supportingEvidences, if (!isPrintView) Some(routes.UploadFilesController.summary) else None, if (!isPrintView) Some({
            case UploadDocumentType.BillOfDischarge3 => routes.UploadBillOfDischarge3Controller.show
            case UploadDocumentType.BillOfDischarge4 => routes.UploadBillOfDischarge4Controller.show
            case _ => routes.UploadFilesController.summary
        }) else None, if (!isPrintView) Some(routes.AddOtherDocumentsController.show) else None))
    }
    
    @claim.securitiesReclaims.headOption.map{ reclaims =>
        @card(messages("check-your-answers.claim-amount"), CheckYourAnswersClaimAmountCardSummary.renderForSecurities(reclaims._2, if (!isPrintView) then Some(routes.SelectDutiesController.showFirst) else None, if (!isPrintView) Some(routes.EnterClaimController.show(reclaims._1,_)) else None))
    }
    
    @claim.temporaryAdmissionMethodsOfDisposal.map{ mods =>
        @card(messages("check-your-answers.securities.disposal-details"), CheckYourAnswersTemporaryAdmissionMethodOfDisposalSummary(claim, mods, isPrintView))
    }

    @if(claim.reasonForSecurity == ReasonForSecurity.InwardProcessingRelief || 
        claim.reasonForSecurity == ReasonForSecurity.EndUseRelief) {
        @card(messages(s"check-your-answers.reimbursement-method.h2"), CheckYourAnswersRepaymentDetailsCardSummary.renderForSecurities(claim, isPrintView))
        @card(messages("check-your-answers.additional-details.securities.h2"), AdditionalDetailsSummary(claim.additionalDetails.getOrElse(messages("check-your-answers.none")), "check-your-answers.additional-details.securities", if(isPrintView) None else Some(routes.EnterAdditionalDetailsController.show)))
    } else if(claim.reasonForSecurity == ReasonForSecurity.MissingPreferenceCertificate) {
        @card(messages(s"check-your-answers.reimbursement-method.h2"), CheckYourAnswersRepaymentDetailsCardSummary.renderForSecurities(claim, isPrintView))
        @card(messages(s"check-your-answers.attached-documents.h2"), CheckYourAnswersSupportingDocumentsCardSummary.withSeparatelyUploadedDocuments(claim.supportingEvidences, if (!isPrintView) Some(routes.UploadFilesController.summary) else None, if (!isPrintView) Some({
            case UploadDocumentType.ProofOfOrigin => routes.UploadProofOfOriginController.show
            case _ => routes.UploadFilesController.summary
        }) else None, if (!isPrintView) Some(routes.AddOtherDocumentsController.show) else None))
        @card(messages("check-your-answers.additional-details.securities.h2"), AdditionalDetailsSummary(claim.additionalDetails.getOrElse(messages("check-your-answers.none")), "check-your-answers.additional-details.securities", if(isPrintView) None else Some(routes.EnterAdditionalDetailsController.show)))
    } else {
        @card(messages("check-your-answers.additional-details.securities.h2"), AdditionalDetailsSummary(claim.additionalDetails.getOrElse(messages("check-your-answers.none")), "check-your-answers.additional-details.securities", if(isPrintView) None else Some(routes.EnterAdditionalDetailsController.show)))
        @card(messages(s"check-your-answers.reimbursement-method.h2"), CheckYourAnswersRepaymentDetailsCardSummary.renderForSecurities(claim, isPrintView))
        @card(messages(s"check-your-answers.attached-documents.h2"), CheckYourAnswersSupportingDocumentsCardSummary(claim.supportingEvidences, if (!isPrintView) Some(routes.UploadFilesController.summary) else None))
    }

    @card(messages("check-your-answers.contact-information.h2"), CheckYourAnswersContactDetailsCardSummary(claim.claimantInformation, if (!isPrintView) Some(routes.EnterContactDetailsController.show) else None, if (!isPrintView) Some(routes.ClaimantAddressController.redirectToALF()) else None))
}

@key = @{"check-your-answers"}
@numberOfSecurities = @{importDeclarationOpt.map(_.getNumberOfSecurityDeposits).getOrElse(0)}

@declarationDetails = {
    @importDeclarationOpt.map { importDeclaration =>
        @subHeading(Html(messages(s"check-your-answers.declaration-details.h2")))
        @summary(SummaryList(
            SecuritiesCdsImportDeclarationSummary(
                importDeclaration,
                s"check-your-answers.declaration-details",
                if(isPrintView) None else Some(routes.EnterMovementReferenceNumberController.show),
                if(isPrintView) None else Some(routes.ChooseReasonForSecurityController.show),
                showImporterDeclarantDetails = false).rows
            ++ SecuritiesSelectionSummary(
                claim.securitiesReclaims,
                importDeclaration,
                key,
                if(isPrintView) None else Some(routes.SelectSecuritiesController.show)).rows
            ++ PayeeTypeSummary(claim.displayPayeeType, s"check-your-answers.payee-type", if(isPrintView) None else Some(routes.ChoosePayeeTypeController.show)).rows
            ++ SecuritiesPaymentMethodSummary(importDeclaration, claim.securitiesReclaims.keySet, s"check-your-answers.payment-method")
        ))
    }
}

@temporaryAdmissionMethodsOfDisposal = {
    @claim.temporaryAdmissionMethodsOfDisposal.map{ mods =>
        @subHeading(Html(messages(s"check-your-answers.securities.claim-details.h2")))
        @summary(CheckYourAnswersTemporaryAdmissionMethodOfDisposalSummary(claim, mods, isPrintView))
    }
}

@contactInformation = {
    @subHeading(Html(messages(s"check-your-answers.contact-information.h2")))
    @summary(
        if(isPrintView)
            ClaimantInformationSummary(
                claimantInformation = claim.claimantInformation,
                key = s"check-your-answers.contact-information"
            )
        else
            ClaimantInformationSummary(
                claimantInformation = claim.claimantInformation,
                key = s"check-your-answers.contact-information",
                changeContactDetailsCall = routes.EnterContactDetailsController.show,
                changeContactAddressCall = Some(routes.ClaimantAddressController.redirectToALF())
            )
    )
}

@securitiesReclaims = {
    @importDeclarationOpt.map { importDeclaration =>
        @claim.securitiesReclaims.map { case (securityDepositId, reclaims) =>
            @if(numberOfSecurities > 1){
                @subHeading(Html(messages(s"check-your-answers.claim-for-security.h2", importDeclarationOpt.map(d => d.getSecurityDepositIdIndex(securityDepositId) + 1).getOrElse(0), numberOfSecurities )))
            } else if (claim.temporaryAdmissionMethodsOfDisposal.isEmpty){
                @subHeading(Html(messages(s"check-your-answers.securities.claim-details.h2")))
            }
            @summary(SecuritiesReclaimDetailsSummary(
                securityDepositId,
                reclaims,
                importDeclaration,
                s"check-your-answers.claim-for-security",
                if(isPrintView) None else Some(routes.ConfirmFullRepaymentController.show),
                if(isPrintView) None else Some(routes.SelectDutiesController.show),
                if(isPrintView) None else Some(routes.EnterClaimController.show)
            ))
        }
    }
}

@bankDetails = {
    @claim.bankAccountDetails.map { bankAccountDetails =>
        @subHeading(Html(messages(s"check-your-answers.bank-details.h2")))
        @summary(BankAccountDetailsSummary(bankAccountDetails, s"check-your-answers.bank-details", if(isPrintView) None else Some(routes.EnterBankAccountDetailsController.show)))
    }
}


@supportingEvidenceLabel = @{
    if(claim.reasonForSecurity==ReasonForSecurity.InwardProcessingRelief || claim.reasonForSecurity==ReasonForSecurity.EndUseRelief || ReasonForSecurity.nidac.contains(claim.reasonForSecurity))
    then messages(s"check-your-answers.other-attached-documents.label")
    else messages(s"check-your-answers.attached-documents.label")
}

@supportingEvidence = {
    @subHeading(Html(messages(s"check-your-answers.attached-documents.h2")))
    @summary(BillOfDischargeDocumentsSummary(claim.supportingEvidences, "check-your-answers.attached-documents", if(isPrintView) None else Some(routes.UploadBillOfDischarge3Controller.show)))
    @summary(ProofOfOriginDocumentSummary(claim.supportingEvidences, "check-your-answers.attached-documents", if(isPrintView) None else Some(routes.UploadProofOfOriginController.show)))
    @summary(EvidenceDocumentsSummary(supportingEvidenceLabel, claim.supportingEvidences, "check-your-answers.attached-documents", if(isPrintView) None else Some(routes.UploadFilesController.summary)))
}


@additionalDetails = {
    @subHeading(Html(messages(s"check-your-answers.additional-details.securities.h2")))
    @summary(AdditionalDetailsSummary(claim.additionalDetails.getOrElse(messages("check-your-answers.none")), "check-your-answers.additional-details.securities", if(isPrintView) None else Some(routes.EnterAdditionalDetailsController.show)))
}

@multipleSecurities = {
    @if(claim.reasonForSecurity == InwardProcessingRelief){
        @declarationDetails
        @supportingEvidence
        @bankDetails
        @additionalDetails
        @contactInformation
    }else{
        @declarationDetails
        @temporaryAdmissionMethodsOfDisposal
        @securitiesReclaims
        @bankDetails
        @supportingEvidence
        @additionalDetails
        @contactInformation
    }
}


@if(isSingleSecurity){
    @singleSecurity 
} else {
    @multipleSecurities
}
